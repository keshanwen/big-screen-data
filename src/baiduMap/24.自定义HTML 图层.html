<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <title>自定义覆盖物-Canvas</title>
  <style>
    body,
    html {
      overflow: hidden;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map_container {
      width: 100%;
      height: 100%;
    }
  </style>
  <script type="text/javascript"
    src="https://api.map.baidu.com/api?type=webgl&v=1.0&ak=vr1ZYIXPstM41N90INIs3L0FtAE3z05G"></script>
  <script type="text/javascript" src="https://mapv.baidu.com/gl/examples/static/common.js"></script>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
</head>

<body style="margin:0">
  <div id="map_container"></div>
</body>

</html>

<script>
  var map = new BMapGL.Map('map_container', {
    style: { styleJson: snowStyle }
  });
  map.centerAndZoom(new BMapGL.Point(116.38623, 39.95577), 15);
  map.enableKeyboard();
  map.enableScrollWheelZoom();

  function createDOM(config) {
    var canvas = document.createElement('canvas');
    var dpr = window.devicePixelRatio || 1;
    canvas.style.width = 150 + 'px'
    canvas.style.height = 150 + 'px'
    canvas.setAttribute('width', 150 * dpr);
    canvas.setAttribute('height', 150 * dpr);

    var ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    ctx.save();
    ctx.beginPath();
    ctx.fillStyle = '#fff';
    ctx.arc(75, 75, 40, 0, Math.PI * 2, true);
    ctx.closePath();
    ctx.fill();

    ctx.save();
    ctx.beginPath();
    ctx.translate(75, 75);
    ctx.rotate(0.6 * Math.PI);
    ctx.lineWidth = config.lineWidth;
    ctx.lineCap = 'round';
    ctx.strokeStyle = config.bgBase;
    ctx.arc(0, 0, config.radius, 0, 1.8 * Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(0, 0, config.radius, 0, 1.8 * Math.PI * config.data);
    ctx.strokeStyle = config.bgFill;
    ctx.stroke();
    ctx.restore();

    ctx.save();
    ctx.beginPath();
    ctx.fillStyle = '#000';
    ctx.font = '26px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(config.data * 100 + '%', config.width * 1.5, config.height * 1.5);
    ctx.restore();

    return canvas;
  }

  // 实例化自定义canvas图层
  var canvasLayer = new BMapGL.CustomHtmlLayer(createDOM, {
    offsetX: 0,
    offsetY: 0,
    minZoom: 13,
    maxZoom: 19,
    enableDraggingMap: true
  });
  var data = {
    type: 'FeatureCollection',
    features: [
      {
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [116.40336, 39.96171]
        },
        properties: {
          width: 50,
          height: 50,
          radius: 50,
          lineWidth: 20,
          bgBase: '#add',
          bgFill: '#9d55ef',
          data: 0.5
        }
      },
      {
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [116.36808, 39.95763]
        },
        properties: {
          width: 50,
          height: 50,
          radius: 50,
          lineWidth: 20,
          bgBase: '#add',
          bgFill: '#a967f5',
          data: 0.3
        }
      },
      {
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [116.39136, 39.94768]
        },
        properties: {
          width: 50,
          height: 50,
          radius: 50,
          lineWidth: 20,
          bgBase: '#add',
          bgFill: '#8a42dc',
          data: 0.8
        }
      }
    ]
  };
  canvasLayer.setData(data);
  // 添加自定义canvas图层到地图上
  map.addCustomHtmlLayer(canvasLayer);
  // 绑定点击事件
  canvasLayer.addEventListener('click', function (e) {
    var data = e.target.properties.data * 100 + '%';
    alert(data);
  });
</script>